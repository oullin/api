name: Go Fmt

on:
  pull_request:
    types: [labeled]

permissions:
    contents: write
    pull-requests: write

jobs:
    gofmt:
        if: github.event.label.name == 'style'
        strategy:
            matrix:
                go-version: [1.25.1]
                os: [ubuntu-latest]

        runs-on: ${{ matrix.os }}

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  repository: ${{ github.event.pull_request.head.repo.full_name }}
                  ref: ${{ github.event.pull_request.head.ref }}
                  fetch-depth: 0

            - name: Install Go
              uses: actions/setup-go@v5
              with:
                  go-version: ${{ matrix.go-version }}

            - name: Run Formatter
              run: git ls-files '*.go' | xargs gofmt -w -s

            - name: Check for formatting changes (dry run)
              run: |
                git diff --exit-code || echo "::warning::Formatting changes would be applied in normal mode"
              continue-on-error: true

            - name: Commit Changes to PR
              if: github.event.pull_request.head.repo.full_name == github.repository
              uses: stefanzweifel/git-auto-commit-action@v6.0.1
              with:
                  commit_message: apply coding style fixes
                  commit_options: '--no-verify'
                  file_pattern: .
                  repository: .
                  commit_user_name: GitHub Actions
                  commit_user_email: ${{ secrets.GUS_GH_EMAIL }}
                  commit_author: gocanto <gocanto@users.noreply.github.com>
                  branch: ${{ github.event.pull_request.head.ref }}
